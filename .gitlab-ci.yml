stages:
  - test
  - terraform

stable:cargo:
  image: rustdocker/rust:stable
  stage: test
  script:
    - free -h
    - lscpu
    - cargo check --verbose
    - cargo test --verbose --jobs 1
    - cargo build --release
    - cargo build
    - cargo doc
    - cargo fmt --all -- --check

terraform:
  image: registry.gitlab.com/gitlab-org/terraform-images/stable:latest
  variables:
    TF_ROOT: infra

  stage: terraform
  script:
    - gitlab-terraform init
    - gitlab-terraform fmt --check
    - gitlab-terraform validate